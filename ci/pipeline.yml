resource_types:
- name: slack_notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest

- name: twitter_notification
  type: docker-image
  source:
    repository: ecsteam/twitter-concourse-resource

resources:
- name: app_sources_dev
  type: git
  source:
    uri: https://github.com/smichard/CloudFoundryDemo.git
    branch: dev
    username: {{github_username}}
    password: {{github_password}}
#    private_key: {{github_private_key}}
  check_every: 10s

- name: app_sources_staging
  type: git
  source:
    uri: git@github.com:smichard/CloudFoundryDemo.git
    branch: staging
    private_key: {{github_private_key}}
  check_every: 20s

- name: app_sources_production
  type: git
  source:
    uri: git@github.com:smichard/CloudFoundryDemo.git
    branch: master
    private_key: {{github_private_key}}
  check_every: 30s

- name: version
  type: semver
  source:
    uri: git@github.com:smichard/CloudFoundryDemo.git
    branch: version
    private_key: {{github_private_key}}
    file: version
    driver: git
    initial_version: 0.5.0 #anpassen

- name: cloud_foundry_dev
  type: cf
  source:
    api: {{cf_api}}
    username: {{cf_user}}
    password: {{cf_password}}
    organization: {{cf_org}}
    space: {{cf_space_dev}}
    skip_cert_check: false

- name: cloud_foundry_staging
  type: cf
  source:
    api: {{cf_api}}
    username: {{cf_user}}
    password: {{cf_password}}
    organization: {{cf_org}}
    space: {{cf_space_staging}}
    skip_cert_check: false

- name: cloud_foundry_production
  type: cf
  source:
    api: {{cf_api}}
    username: {{cf_user}}
    password: {{cf_password}}
    organization: {{cf_org}}
    space: {{cf_space_production}}
    skip_cert_check: false

- name: tracker_output
  type: tracker
  source:
    token: {{traker_api_token}}
    project_id: {{tracker-project-id}}
    tracker_url: https://www.pivotaltracker.com

- name: s3_target
  type: s3
  source:
    endpoint: {{s3_endpoint}}
    bucket: releases
    regexp: release_history/release.tgz
    access_key_id: {{s3_key}}
    secret_access_key: {{s3_secret}}

- name: slack_msg
  type: slack_notification
  source:
    url: {{slack_hook}}

- name: twitter_msg
  type: twitter_notification
  source:
    consumer_key: {{twitter_consumer_key}}
    consumer_secret: {{twitter_consumer_secret}}
    access_token: {{twitter_access_token}}
    access_token_secret: {{twitter_access_token_secret}}


jobs:
  - name: test-dev
    public: true
    serial: true
    plan:
      - get: app_sources_dev
        trigger: true
      - task: unit
        file: app_sources_dev/ci/tasks/unit.yml
      - put: tracker_output
        params:
          repos:
          - app_sources_dev

  - name: deploy-dev
    public: true
    serial: true
    plan:
    - get: app_sources_dev
      passed: [ test-dev ]
      trigger: true
    - put: cloud_foundry_dev
      params:
        path: app_sources_dev/
        manifest: app_sources_dev/manifest_dev.yml
      on_success:
        put: slack_msg
        params:
          channel: '#general'
          text: |
            Dev: The build $BUILD_JOB_NAME with build ID $BUILD_ID for pipeline $BUILD_PIPELINE_NAME completed succesfully. Check the current development state at:
            https://cloudfoundry-demo-sym-dev.cfapps.io/
      on_failure:
        put: slack_msg
        params:
          channel: '#general'
          text: |
            Dev: The build $BUILD_JOB_NAME with build ID $BUILD_ID for pipeline $BUILD_PIPELINE_NAME failed. Check it out at:
            http://127.0.0.1:8080/builds/$BUILD_ID

  - name: test-staging
    public: true
    serial: true
    plan:
      - get: app_sources_staging
        trigger: true
      - task: unit
        file: app_sources_staging/ci/tasks/unit.yml

  - name: deploy-staging
    public: true
    serial: true
    plan:
    - get: app_sources_staging
      passed: [ test-staging ]
      trigger: true
    - put: cloud_foundry_staging
      params:
        path: app_sources_staging/
        manifest: app_sources_staging/manifest_staging.yml
      on_success:
        put: slack_msg
        params:
          channel: '#general'
          text: |
            Staging: The build $BUILD_JOB_NAME with build ID $BUILD_ID for pipeline $BUILD_PIPELINE_NAME completed succesfully. Check the current development state at:
            https://cloudfoundry-demo-sym-staging.cfapps.io/
      on_failure:
        put: slack_msg
        params:
          channel: '#general'
          text: |
            Staging: The build $BUILD_JOB_NAME with build ID $BUILD_ID for pipeline $BUILD_PIPELINE_NAME failed. Check it out at:
            http://127.0.0.1:8080/builds/$BUILD_ID

  - name: merge-release-to-master
    public: true
    plan:
      - aggregate:
        - get: app_sources_production
        - get: app_sources_staging
          passed: [ test-staging ]
        - task: merge-release-to-master
          file: app_sources_staging/ci/tasks/merge-release-branch.yml
          params:
            GIT_EMAIL: {{git_mail}}
            GIT_NAME: {{git_name}}
        - put: app_sources_production
          params:
            repository: out
          on_success:
            put: slack_msg
            params:
              channel: '#general'
              text: |
                Release branch succesfully merged to master branch: The build $BUILD_JOB_NAME with build ID $BUILD_ID for pipeline $BUILD_PIPELINE_NAME completed succesfully.
          on_failure:
            put: slack_msg
            params:
              channel: '#general'
              text: |
                Release branch failed to merged with master branch: The build $BUILD_JOB_NAME with build ID $BUILD_ID for pipeline $BUILD_PIPELINE_NAME failed. Check it out at:
                http://127.0.0.1:8080/builds/$BUILD_ID

  - name: test-master
    public: true
    serial: true
    plan:
      - get: app_sources_production
        passed: [ merge-release-to-master ]
        trigger: true
      - task: unit
        file: app_sources_production/ci/tasks/unit.yml

  - name: tag-master
    public: true
    plan:
      - aggregate:
        - get:  app_sources_production
          passed: [ test-master ]
          trigger: true
        - get: app_sources_staging
        - get: version
      - task: bump-to-release-version
        file: app_sources_staging/ci/tasks/bump-to-release-version.yml
        params:
          GIT_EMAIL: {{git_mail}}
          GIT_NAME: {{git_name}}
      - put: app_sources_production
        params:
          repository: out
          tag: version/number
      - put: s3_target
        params:
          file: app_sources_production
          acl: public-read

  - name: bump-version
    public: true
    plan:
      - aggregate:
        - get:  app_sources_production
          passed: [ tag-master ]
          trigger: true
        - get:  app_sources_staging
        - get: version
          params: {bump: minor}
      - task: bump-to-next-develop-version
        file: repo/ci/tasks/bump-to-next-develop-version.yml
        params:
          GIT_EMAIL: {{git_mail}}
          GIT_NAME: {{git_name}}
      - put: app_sources_staging
        params:
          repository: out
      - put: version
        params: {file: version/number}

  - name: merge-release-to-develop
    public: true
    plan:
      - aggregate:
        - get: app_sources_dev
        - get: app_sources_staging
          passed: [ bump-version ]
          trigger: true
      - task: merge-release-to-develop
        file: app_sources_staging/ci/tasks/merge-release-branch.yml
        params:
          GIT_EMAIL: {{git_mail}}
          GIT_NAME: {{git_name}}
      - put: app_sources_dev
        params:
          repository: out

  - name: deploy-master
    public: true
    serial: true
    plan:
    - get: app_sources_production
      passed: [ test-master ]
      trigger: true
    - put: cloud_foundry_production
      params:
        path: app_sources_production/
        manifest: app_sources_production/manifest.yml
      on_success:
        put: slack_msg
        params:
          channel: '#general'
          text: |
            Production: The build $BUILD_JOB_NAME with build ID $BUILD_ID for pipeline $BUILD_PIPELINE_NAME completed succesfully. Check the current development state at:
            http://cloudfoundry-demo-sym.cfapps.io/
        put: twitter_msg
        params:
          status: >
            Just deployed a new version of my app to Cloud Foundry with @concourseci (build ${BUILD_ID}) - check it out http://cloudfoundry-demo-sym.cfapps.io/
      on_failure:
        put: slack_msg
        params:
          channel: '#general'
          text: |
            Production: The build $BUILD_JOB_NAME with build ID $BUILD_ID for pipeline $BUILD_PIPELINE_NAME failed. Check it out at:
            http://127.0.0.1:8080/builds/$BUILD_ID
