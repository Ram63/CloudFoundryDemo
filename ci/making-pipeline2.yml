to do:
  understand merge
  understand tag master
  understand bump
  update links in slack messages
  test pipeline
  include S3 target


jobs:

  - name: bump-version
    public: true
    plan:
      - aggregate:
        - get:  repo-master
          passed: [ tag-master ]
          trigger: true
        - get:  repo
          resource: repo-release
        - get: version
          params: {bump: minor}
        - get: m2
      - task: bump-to-next-develop-version
        file: repo/ci/tasks/bump-to-next-develop-version.yml
        params:
          GIT_EMAIL: {{git-email}}
          GIT_NAME: {{git-name}}
      - put: repo
        resource: repo-release
        params:
          repository: out
      - put: version
        params: {file: version/number}

  - name: merge-release-to-develop
    public: true
    plan:
      - aggregate:
        - get: repo
          resource: repo-develop
        - get: repo-release
          passed: [ bump-version ]
          trigger: true
      - task: merge-release-to-develop
        file: repo-release/ci/tasks/merge-release-branch.yml
        params:
          GIT_EMAIL: {{git-email}}
          GIT_NAME: {{git-name}}
      - put: repo
        resource: repo-develop
        params:
          repository: out

  - name: deploy-prod
    serial: true
    public: false
    plan:
      - aggregate:
        - get: m2
        - get:  repo
          resource: repo-master
          passed: [ tag-master ]
          trigger: true
      - task: build
        file: repo/ci/tasks/build.yml
      - put: cf-prod
        params:
          manifest: repo/manifest.yml
          path: output/demo.jar
          current_app_name: concourse-ci-demo
